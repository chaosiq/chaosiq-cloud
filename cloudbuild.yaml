tags:
- console

timeout: 3600s

steps:
###############################################################################
# Notify the team about the build starting
###############################################################################
- name: 'gcr.io/chaosiq-devops/slackbot'
  id: Notify the team about the build starting
  entrypoint: /bin/sh
  args:
  - '-c'
  - |
    /go/bin/main --build=$BUILD_ID --webhook=$$SLACK_WEBHOOK_URL
  secretEnv: ['SLACK_WEBHOOK_URL']

###############################################################################
# Build the final container image
###############################################################################
- name: gcr.io/cloud-builders/docker
  id: Build console backend image
  args:
  - build
  - '--tag=gcr.io/chaosiq-devops/chaostoolkit:$SHORT_SHA'
  - '--tag=gcr.io/chaosiq-devops/chaostoolkit:latest'
  - '--file=Dockerfile'
  - .

images:
  - 'gcr.io/chaosiq-devops/chaostoolkit:$SHORT_SHA'
  - 'gcr.io/chaosiq-devops/chaostoolkit:latest'

secrets:
- kmsKeyName: 'projects/chaosiq-devops/locations/global/keyRings/ci/cryptoKeys/cloudbuilds'
  secretEnv:
    SLACK_WEBHOOK_URL: 'CiQA0IkRxexyiSaDl+epM9j5T/wYu0ct6sn7iUMgpdi9bMe90psSdwBrgwFn38criOFVJRk0rVpOzgJeaLj9EJrdsl9/h2Q4i9bFk/OpfTuQ05v6kBU7/hbgB4wC1OE2eNd9LW4K28kate6EzdJcEWMii/E3irARWdizaJKZdNpTZJO67WIgxeefUArwSl3+B/fKW/mWNECrJBj2SS89'
